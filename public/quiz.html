<!DOCTYPE html>
<html lang="pt-br">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <!-- Favicon icon-->
    <link rel="shortcut icon" type="image/png" href="./assets/images/desafia_mascote.ico" />

    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet"
        integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">

    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">

    <link rel="stylesheet" href="./assets/styles/style.css">

    <title>Quiz - Desaf.IA</title>
</head>

<body>
    <!-- Header do Quiz -->
    <div class="quiz-header">
        <div class="container">
            <div class="row align-items-center">
                <div class="col-md-8">
                    <h1 class="h2 mb-1">
                        <i class="bi bi-trophy me-2"></i>
                        Tema: <span id="quizTheme">Carregando...</span>
                    </h1>
                    <p class="mb-0 opacity-75">
                        <i class="bi bi-lightbulb me-2"></i>
                        <span id="courseName">Carregando...</span>
                    </p>
                </div>
                <div class="col-md-4 text-md-end">
                    <div class="d-flex justify-content-md-end align-items-center mt-3 mt-md-0">
                        <div class="me-3">
                            <small class="d-block opacity-75">Pergunta</small>
                            <strong><span id="currentQuestion">0</span> / <span id="totalQuestions">0</span></strong>
                        </div>
                        <button class="btn btn-outline-light btn-sm" onclick="goHome()" title="Voltar ao início">
                            <i class="bi bi-house-door"></i>
                        </button>
                    </div>
                </div>
            </div>

            <!-- Barra de Progresso -->
            <div class="mt-3">
                <div class="progress progress-custom">
                    <div class="progress-bar" role="progressbar" id="progressBar" aria-label="Progresso do quiz"
                        aria-valuenow="0" aria-valuemin="0" aria-valuemax="100"></div>
                </div>
            </div>
        </div>
    </div>

    <div class="container my-5">
        <div class="d-flex flex-column align-items-end">
            <textarea class="form-control custom-textarea" id="caixaPergunta" rows="5"
                placeholder="Faça sua pergunta aqui..."></textarea>

            <button type="button" class="btn btn-outline-light custom-btn mt-3">Enviar</button>
        </div>

        <!-- Área de Resposta da IA -->
        <div id="respostaIA" class="mt-4" style="display: none;">
            <div class="card bg-dark border-secondary">
                <div class="card-header bg-primary">
                    <h6 class="mb-0 text-white">
                        <i class="bi bi-robot me-2"></i>
                        Resposta da IA
                    </h6>
                </div>
                <div class="card-body">
                    <p id="textoResposta" class="text-light mb-0"></p>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"
        integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz"
        crossorigin="anonymous"></script>

    <script>
        // Variáveis globais
        let quizConfig = null;
        let currentQuestionIndex = 0;
        let questions = [];
        let teamScores = {};

        // Elementos DOM
        const quizArea = document.getElementById('quizArea');
        const errorMessage = document.getElementById('errorMessage');
        const btnEnviarPergunta = document.getElementById('btnEnviarPergunta');
        const caixaPergunta = document.getElementById('caixaPergunta');
        const respostaIA = document.getElementById('respostaIA');
        const textoResposta = document.getElementById('textoResposta');

        // Inicializar a página
        document.addEventListener('DOMContentLoaded', async () => {
            try {
                await loadGameSession();
            } catch (error) {
                showError(error.message);
            }
        });

        // Função para carregar dados da sessão do jogo
        async function loadGameSession() {
            try {
                // Verificar se existe uma sessão salva no localStorage
                const gameSessionId = localStorage.getItem('gameSessionId');
                const gameCreated = localStorage.getItem('gameCreated');

                if (!gameSessionId || !gameCreated) {
                    throw new Error('Nenhum jogo encontrado. Redirecionando para página inicial...');
                }

                // Buscar dados da sessão no backend
                const response = await fetch('/api/session/game-session', {
                    method: 'GET',
                    credentials: 'include'
                });

                if (response.ok) {
                    const sessionData = await response.json();

                    quizConfig = sessionData.gameData;
                    displayGameInfo(sessionData.gameData);

                    console.log('Dados da sessão carregados:', sessionData);
                } else {
                    const error = await response.json();
                    console.error('Erro ao carregar sessão:', error);
                    throw new Error('Erro ao carregar dados do jogo');
                }

            } catch (error) {
                console.error('Erro:', error);
                throw new Error(error.message || 'Erro ao conectar com o servidor');
            }
        }

        // Função para exibir informações do jogo
        function displayGameInfo(gameData) {
            // Atualizar elementos da página com os dados do jogo
            document.getElementById('courseName').textContent = gameData.courseName;
            document.getElementById('quizTheme').textContent = gameData.quizTheme;
            document.getElementById('totalQuestions').textContent = gameData.questionCount;

            console.log('Informações do jogo atualizadas:', {
                courseName: gameData.courseName,
                quizTheme: gameData.quizTheme,
                questionCount: gameData.questionCount,
                teamCount: gameData.teamCount
            });
        }

        // Reiniciar quiz
        function restartQuiz() {
            currentQuestionIndex = 0;
            initializeTeamScores();
            displayQuestion();
        }

        // Voltar para home
        function goHome() {
            window.location.href = 'index.html';
        }

        // Mostrar erro
        function showError(message) {
            loadingStatus.classList.add('d-none');
            quizArea.classList.add('d-none');
            teamsScoreboard.classList.add('d-none');
            errorMessage.classList.remove('d-none');
            document.getElementById('errorText').textContent = message;
        }

        // Função para gerar perguntas usando IA
        async function gerarPerguntasIA() {
            try {
                console.log('Gerando perguntas com IA...');
                const response = await fetch('/api/ia/generate-questions', {
                    method: 'POST',
                    credentials: 'include'
                });

                if (response.ok) {
                    const result = await response.json();
                    console.log('Perguntas geradas pela IA:', result);

                    // Substituir perguntas simuladas pelas geradas pela IA
                    questions = result.questions.map((q, index) => ({
                        id: q.id || index + 1,
                        question: q.pergunta,
                        options: q.opcoes,
                        correctAnswer: q.resposta_correta,
                        explanation: q.explicacao
                    }));

                    return questions;
                } else {
                    const error = await response.json();
                    console.error('Erro ao gerar perguntas:', error);
                    throw new Error(error.message || 'Erro ao gerar perguntas');
                }
            } catch (error) {
                console.error('Erro na geração de perguntas:', error);
                // Fallback para perguntas simuladas se a IA falhar
                generateSampleQuestions();
                return questions;
            }
        }

        // Função para enviar pergunta para IA (exemplo de uso)
        async function enviarPerguntaIA(pergunta, contexto = '') {
            try {
                const response = await fetch('/api/ia/ask', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    credentials: 'include',
                    body: JSON.stringify({
                        pergunta,
                        contexto
                    })
                });

                if (response.ok) {
                    const result = await response.json();
                    console.log('Resposta da IA:', result);
                    return result.resposta;
                } else {
                    const error = await response.json();
                    console.error('Erro ao enviar pergunta:', error);
                    throw new Error(error.message || 'Erro ao processar pergunta');
                }
            } catch (error) {
                console.error('Erro na comunicação com IA:', error);
                throw error;
            }
        }
    </script>

</body>

</html>